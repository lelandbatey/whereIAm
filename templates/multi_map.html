<!DOCTYPE html>
<html>
<head>
	<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB5l8Y_pDgxKIp2K1icKCHcUcoQ0b_SVGU&sensor=true&libraries=geometry"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	<script data-main="static/main" src="/static/require.js"></script>
	<script src="/static/tinycolor.js"></script>
	<title>Multi Maps.</title>
	<style type="text/css">

#container {
	width: 1920px;
	margin-right: auto;
	margin-left: auto;
	*zoom: 1;
}
.map-container { 
	height: 360px;
	width: 240px;
	border: 1px dotted grey;
	float: left;
	display: flex;
	flex-direction: column;
}
.map-canvas {
	height: 100%;
	width: 100%;
}
.map-info {
	min-height: 60px;
	font-size: 6px;
	margin: 0;
}

/*======= Map Styling ============*/
.gmnoprint a, .gmnoprint span {
    display:none;
}
.gmnoprint div {
    background:none !important;
}
#GMapsID div div a div img{
    display:none;
}
.gm-style div a div img {
	display: none;
}
img[src=http://maps.gstatic.com/mapfiles/api-3/images/google_white2.png] {
	display:none;
}
img[src=https://maps.gstatic.com/mapfiles/api-3/images/google_white2_hdpi.png] {
	display:none;
}

	</style>
</head>
<body>
	<div id="container">
		<!-- <div id="map-canvas">	
		</div> -->
	</div>
</body>
<script type="text/javascript">

function jp(obj){ console.log(JSON.stringify(obj, null, 4)); }

function translate_domain(d_start, d_stop, d_val, n_start, n_stop){
	var d = d_stop - d_start;
	var v = d_val - d_start;
	var ratio = v/d;
	var nd = n_stop - n_start;
	var nv = (ratio * nd) + n_start;
	return nv;
}

function normalize_radian(r){
	r = r % (Math.PI*2.0);
	r = (r + (Math.PI*2.0)) % (Math.PI*2.0);
	return r;
}

var date_parse = function (dateStr){
	// Assumes the date is formatted as such: "%H:%M:%S %d-%m-%y"
	var left = dateStr.split(' ')[0];
	var right = dateStr.split(' ')[1];

	left = left.split(':');
	right = right.split('-');
	var hour   = +left[0];
	var minute = +left[1];
	var second = +left[2];

	var day   = +right[0];
	var month = +right[1]-1;
	var year  = +right[2]+2000;
	// console.log(year, month, day, hour, minute, second, 0);
	var out_date = new Date(year, month, day, hour, minute, second, 0);
	return out_date;
}


function color_interpolate(c0, c1, percent){
	function interpolater(a, b, t){
		return a * (1 - t) + b * t;
	}
	h0 = c0.toHsv();
	h1 = c1.toHsv();
	var h = interpolater(h0.h, h1.h, percent);
	var s = interpolater(h0.s, h1.s, percent);
	var v = interpolater(h0.v, h1.v, percent);

	var tmp = tinycolor({h:h, s:s, v:v});
	return tmp;	
}

// Creates an array of colors transitioning between multiple colors, instead
// of from just one color to another.
function getColorRanges(colors, data){
	var subRangeLen = Math.ceil(data.length/(colors.length-1));
	var colorRange = [];

	for (var i = 0; i < colors.length-1; i++) {
		for (var x = 0; x < subRangeLen; x++) {
			var ratio = x/subRangeLen;
			var currentColor = color_interpolate(colors[i], colors[i+1], ratio);
			colorRange.push(currentColor);
		};
	};
	if (colorRange.length > data.length) {
		colorRange = colorRange.slice(0, data.length-1);
	};
	return colorRange;
}

function bearingToColor(bearing){
	var linehue = Math.round((180/Math.PI)*bearing);
	if (linehue < 0) { linehue += 360; };
	return tinycolor("hsl("+String(linehue)+", 100%, 50%)").toHexString();
}

// Given a list of coordinates, create one map for each pair of
// coordinates, then place those coordinates on that map.
function mapCoordinatePairs(inputData){

	var container = document.getElementById("container");
	var maxMapCount = 200;
	if (maxMapCount > inputData.length-1) { maxMapCount = inputData.length-1; };

	/*
		Takes an object with `latitude` and `longitude` attributes and converts
		them to a GoogleMaps LatLng object.
	*/
	function rawToLatLng(inval){
		return new google.maps.LatLng(inval.latitude, inval.longitude);
	}

	// Given the current index, creates an object representing a group of line
	// segments to be shown on a map.
	function createCoordGroup(index, count){
		var len = maxMapCount;
		
		if (arguments.length < 2) {
			count = 4;
		};

		var group = {};
		group.debug_info = "";
		group.debug = function(to_log){group.debug_info += String(to_log);}
		group.coords = [];
		group.indices = [];
		// [i-1] -- [ i ] -- [i+1] -- [i+2]
		for (var i = -1; i < count; i++){
			if (index+i < len) {
				var latlng = rawToLatLng(inputData[index+i]);
				group.indices.push(index+i);
				group.coords.push(latlng);
			};
		}

		group.bounds = new google.maps.LatLngBounds();
		for (var i = 0; i < group.coords.length-1; i++){
			group.bounds.extend(group.coords[i]);
		}

		group.createLines = function(map){
			for (var i = 1; i < group.coords.length-1; i++){
				var bearing = inputData[group.indices[i]].derived_bearing;
				bearing = normalize_radian(bearing);
				var lineColor = bearingToColor(bearing);

				if (i > 1) {
					var prevBearing = inputData[group.indices[i-1]].derived_bearing;
					prevBearing = normalize_radian(prevBearing);
					var diff = Math.abs(bearing - prevBearing) % Math.PI;
					group.debug("prevBearing: "+prevBearing+"\n");
					group.debug("currBearing: "+bearing+"\n");
					group.debug("diff: "+diff+"\n");
					lineColor = bearingToColor(Math.PI+diff);
				};

				var lineSymbol = {
					scale: 2,
					path: google.maps.SymbolPath.FORWARD_OPEN_ARROW
				};
				new google.maps.Polyline({
					path: [group.coords[i-1], group.coords[i]],
					geodesic: true,
					strokeColor: lineColor,
					strokeOpacity: 1.0,
					strokeWeight: 4,
					map: map,
					icons: [{
						icon: lineSymbol,
						offset: '100%'
					}]
				})
			}
		}

		return group;
	}

	for (var i = 1; i < maxMapCount; i++) {
		var group = createCoordGroup(i);

		var parent = document.createElement("div");
		parent.className = "map-container";
		var elm = document.createElement("div");
		elm.className = "map-canvas";
		var info = document.createElement("pre");
		info.className = "map-info";

		var map = new google.maps.Map(elm, {disableDefaultUI: true});

		group.createLines(map);
		map.fitBounds(group.bounds);

		var infoContent = document.createTextNode(group.debug_info);
		info.appendChild(infoContent);
		parent.appendChild(elm);
		parent.appendChild(info);
		container.appendChild(parent);
	};
}

function createMap(inputData){
	console.log(inputData);
	var coords = [];

	for (var i = inputData.length - 1; i >= 0; i--) {
		coords.push(new google.maps.LatLng (inputData[i].latitude, inputData[i].longitude));
	};
	var mapOptions = {
		center: coords[0],
		zoom: 16
	};
	var map = new google.maps.Map(document.getElementById("map-container"), mapOptions);
	
	// var startColor = tinycolor("#55ACEE");
	// var endColor = tinycolor("#DD3DD3");
	// Create a different color for each coordinate.
	var colorRanges = [
		"red",
		"blue",
		"red",
		"blue"
	].map(tinycolor);

	var colors = getColorRanges(colorRanges, coords);
	// for (var i = 0; i < coords.length; i++) {
	// 	var dist = i/(coords.length-1);
	// 	var currentColor = color_interpolate(startColor, endColor, dist);
	// 	colors.push(currentColor);
	// };

	var paths = [];
	// Create a new Polyline for each coordinate pair so we can set the color
	// for each individually.
	for (var i = 0; i < coords.length-1; i++) {
		// var currentColor = colors[i];
		var dataIndex = i- (i>1?1:-2);
		var bearing = inputData[dataIndex].derived_bearing;
		var linehue = Math.round((180/Math.PI)*bearing);
		if (linehue < 0) { linehue += 360; };
		console.log("bearing:", bearing)
		console.log("dataIndex:", dataIndex);
		console.log('linehue:', linehue)
		var currentColor = tinycolor("hsl("+String(linehue)+", 100%, 50%)");
		var path = new google.maps.Polyline({
			path: [coords[i], coords[i+1]],
			geodesic: true,
			strokeColor: currentColor.toHexString(),
			strokeOpacity: 1.0,
			strokeWeight: 4,
			map: map

		});
		paths.push(path);
	};
};

// Start: 1423425600
// Stop : 1423512000
function initialize() {
	var start = "08:30:00 01-06-15";
	var end =   "18:00:00 05-06-15";

	console.log(date_parse(start));
	console.log(date_parse(end));
	start = date_parse(start).getTime()/1000;
	end = date_parse(end).getTime()/1000;

	console.log(start);
	console.log(end);

	$.ajax({
		url: '/data_range/'+start+'.0/'+end+'.0',
		// url: '/last_range/800',
		dataType: 'json',
		success: mapCoordinatePairs
	});
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>
</html>